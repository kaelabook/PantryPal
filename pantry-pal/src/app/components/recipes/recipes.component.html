<app-navbar></app-navbar>

<div class="recipes-container">
  <h2 class="center-heading">Your Recipes</h2>

  <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
  </div>

  <div *ngIf="isLoading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Loading recipes...</p>
  </div>

  <div class="recipes-grid" *ngIf="!isLoading">
    <div class="recipe-card" *ngFor="let recipe of savedRecipes">
      <h3>{{ recipe.name }}</h3>
      <p class="recipe-description">{{ recipe.description | slice:0:100 }}...</p>

      <div class="ingredients-list">
        <strong>Ingredients:</strong>
        <ul>
          <li *ngFor="let ingredient of recipe.ingredients">
            {{ ingredient.name }} ({{ ingredient.quantity }} {{ ingredient.unit }})
          </li>
        </ul>
      </div>

      <div class="button-group">
        <button class="view-btn" (click)="viewRecipe(recipe)">View</button>
        <button class="edit-btn" (click)="editRecipe(recipe)">Edit</button>
        <button class="cook-btn" (click)="prepareCookRecipe(recipe)">Cook</button>
        <button class="delete-btn" (click)="deleteRecipe(recipe)">Delete</button>
      </div>
    </div>
  </div>

  <button class="floating-button" (click)="toggleRecipeForm()">+</button>
</div>

<!-- View Recipe Popup -->
<div class="popup" *ngIf="selectedRecipe">
  <div class="popup-content">
    <h2>{{ selectedRecipe.name }}</h2>
    <p><strong>Description:</strong> {{ selectedRecipe.description }}</p>
    <p><strong>Cook Time:</strong> {{ selectedRecipe.cookTime }} mins</p>
    <p><strong>Temperature:</strong> {{ selectedRecipe.temperature }} °F</p>
    <p><strong>Servings:</strong> {{ selectedRecipe.servings }}</p>
    <p><strong>Ingredients:</strong></p>
    <ul>
      <li *ngFor="let ingredient of selectedRecipe.ingredients">
        {{ ingredient.name }} - {{ ingredient.quantity }} {{ ingredient.unit }}
      </li>
    </ul>
    <p><strong>Instructions:</strong></p>
    <div class="instructions">{{ selectedRecipe.instructions }}</div>

    <div class="button-group">
      <button (click)="closeRecipeView()">Close</button>
      <button class="cook-btn" (click)="prepareCookRecipe(selectedRecipe)">Cook This Recipe</button>
    </div>
  </div>
</div>

<!-- Cook Confirmation Popup -->
<div class="popup" *ngIf="showCookConfirmation">
  <div class="popup-content">
    <h2>Cooking {{ cookData.recipe.name }}!</h2>
    
    <p class="cook-message">{{ cookData.message }}</p>
    
    <div *ngIf="cookData.pantryItems.length > 0">
      <h3>Items to be used from pantry:</h3>
      <ul>
        <li *ngFor="let item of cookData.pantryItems">
          {{ item.name }} - {{ item.quantity }} {{ item.unit }}
        </li>
      </ul>
    </div>
    
    <div *ngIf="cookData.missingItems.length > 0" class="missing-items">
      <h3>Items to be added to shopping cart:</h3>
      <ul>
        <li *ngFor="let item of cookData.missingItems">
          {{ item.name }} - {{ item.quantity }} {{ item.unit }}
        </li>
      </ul>
    </div>
    
    <div class="button-group">
      <button (click)="showCookConfirmation = false">Cancel</button>
      <button class="confirm-btn" (click)="executeCookRecipe()">Confirm</button>
    </div>
  </div>
</div>

<!-- Add/Edit Recipe Form -->
<div class="popup" *ngIf="showRecipeForm">
  <form (ngSubmit)="saveRecipe()" class="form-container">
    <h2>{{ isEditing ? 'Edit' : 'Create' }} Recipe</h2>

    <div class="form-group">
      <label for="recipeName">Recipe Name:</label>
      <input type="text" id="recipeName" [(ngModel)]="currentRecipe.name" name="recipeName" required>
    </div>

    <div class="form-group">
      <label for="recipeDescription">Description:</label>
      <textarea id="recipeDescription" [(ngModel)]="currentRecipe.description" name="recipeDescription"></textarea>
    </div>

    <div class="ingredients-section">
      <h3>Ingredients</h3>
      <div class="ingredient-scroll-container">
        <div *ngFor="let ingredient of currentRecipe.ingredients; let i = index" class="ingredient-form">
          <h4>Ingredient {{ i + 1 }}</h4>
          
          <div class="form-group">
            <label [for]="'ingredientName' + i">Name:</label>
            <input type="text" 
                  [id]="'ingredientName' + i" 
                  [(ngModel)]="ingredient.name" 
                  [name]="'ingredientName' + i" 
                  (input)="filterPantryItems(ingredient.name, i)"
                  required>
            
            <div class="suggestions-dropdown" *ngIf="ingredient.name && filteredPantryItems.length > 0 && activeIngredientIndex === i">
              <div *ngFor="let item of filteredPantryItems" 
                  class="suggestion-item"
                  (click)="selectPantryItem(item)">
                {{ item.name }} ({{ item.quantity }} {{ item.unit || 'units' }})
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label [for]="'ingredientQuantity' + i">Quantity:</label>
              <input type="number" 
                    [id]="'ingredientQuantity' + i" 
                    [(ngModel)]="ingredient.quantity" 
                    [name]="'ingredientQuantity' + i" 
                    min="0.1" 
                    step="0.1" 
                    required>
            </div>

            <div class="form-group">
              <label [for]="'ingredientUnit' + i">Unit:</label>
              <input type="text" 
                    [id]="'ingredientUnit' + i" 
                    [(ngModel)]="ingredient.unit" 
                    [name]="'ingredientUnit' + i">
            </div>
          </div>

          <button type="button" (click)="removeIngredient(i)" class="delete-button">Remove Ingredient</button>
        </div>
      </div>
      <button type="button" (click)="addIngredient()" class="add-ingredient-btn">Add Ingredient</button>
    </div>

    <div class="form-group">
      <label for="recipeInstructions">Instructions:</label>
      <textarea id="recipeInstructions" [(ngModel)]="currentRecipe.instructions" name="recipeInstructions" required></textarea>
    </div>

    <div class="form-row">
      <div class="form-group slider-group">
        <label for="cookTime">Cook Time (minutes):</label>
        <input type="range" id="cookTime" [(ngModel)]="currentRecipe.cookTime" name="cookTime" min="1" max="480" step="1">
        <span>{{ currentRecipe.cookTime }} minutes</span>
      </div>

      <div class="form-group slider-group">
        <label for="temperature">Temperature (°F):</label>
        <input type="range" id="temperature" [(ngModel)]="currentRecipe.temperature" name="temperature" min="100" max="500" step="1">
        <span>{{ currentRecipe.temperature }}°F</span>
      </div>

      <div class="form-group">
        <label for="servings">Servings:</label>
        <input type="number" id="servings" [(ngModel)]="currentRecipe.servings" name="servings" min="1" required>
      </div>
    </div>

    <div class="submit-row">
      <button type="button" (click)="toggleRecipeForm()">Cancel</button>
      <button type="submit">{{ isEditing ? 'Save' : 'Create' }} Recipe</button>
    </div>
  </form>
</div>